<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOMADS TACTICAL TERMINAL v3.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <script src="nomads_db.js"></script>

    <style>
        body { background: #0d0f12; color: #00ff41; font-family: 'Share Tech Mono', monospace; padding: 15px; border: 1px solid #00ff41; min-height: 100vh; box-sizing: border-box; margin: 0; }
        h2 { text-shadow: 0 0 10px #00ff41; text-align: center; text-transform: uppercase; border-bottom: 1px solid #00ff41; padding-bottom: 10px; }
        .section { background: rgba(0,255,65,0.05); border: 1px solid #00ff41; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        input, select { background: #000; color: #00ff41; border: 1px solid #00ff41; width: 100%; padding: 12px; margin: 8px 0; font-family: inherit; font-size: 14px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; margin-top: 10px; cursor: pointer; font-family: inherit; font-size: 16px; font-weight: bold; text-transform: uppercase; border: none; }
        .btn-nomad { background: #00ff41; color: #000; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%); }
        .btn-status { background: #111; color: #00ff41; border: 1px solid #00ff41; margin-top: 5px; font-size: 12px; }
        .recording { background: #ff0000 !important; color: white !important; animation: blink 1s infinite; box-shadow: 0 0 15px #ff0000; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #console { font-size: 12px; margin-top: 20px; color: #00ff41; background: #000; padding: 15px; border: 1px solid #008f11; height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .roster-list { font-size: 12px; margin-top: 10px; border-top: 1px dashed #00ff41; padding-top: 10px; }
    </style>
</head>
<body>
    <h2>-- CORREGIDOR DATANET --</h2>
    
    <div id="setup">
        <div class="section">
            <h3 style="margin-top:0; font-size: 14px;">SCHIERAMENTO TRUPPE</h3>
            
            <select id="dbSelect">
                <option value="">-- SELEZIONA PROFILO DAL DATABASE --</option>
            </select>
            
            <input type="text" id="unitAlias" placeholder="ASSEGNA SOPRANNOME (es. ALFA)">
            
            <button class="btn-nomad" onclick="addUnitFromDB()">AGGIUNGI ALLA SQUADRA</button>
            
            <div id="localRoster" class="roster-list">UnitÃ  in attesa: 0</div>
        </div>
        <button class="btn-status" onclick="startBattle()">INIZIA PARTITA (ATTIVA IA)</button>
    </div>

    <div id="battle" style="display:none;">
        <button id="btnListen" class="btn-nomad">ðŸŽ¤ COMANDO VOCALE</button>
        <div id="console">[SISTEMA OPERATIVO]: Microfono in standby...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // --- REGISTRAZIONE SERVICE WORKER E WAKELOCK ---
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        
        let wakeLock = null;
        document.addEventListener('click', async () => {
            if ('wakeLock' in navigator && !wakeLock) wakeLock = await navigator.wakeLock.request('screen');
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{});
        });

        // --- FIREBASE CONFIG (Incolla la tua) ---
        const firebaseConfig = { 
            apiKey: "IL_TUO_API_KEY",
            projectId: "IL_TUO_PROGETTO",
            // ...
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- POPOLAMENTO MENU A TENDINA ---
        window.onload = () => {
            const select = document.getElementById('dbSelect');
            // Ordina alfabeticamente il database
            window.masterNomadsDatabase.sort((a, b) => a.nome.localeCompare(b.nome));
            
            window.masterNomadsDatabase.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id_profilo;
                // Mostra Nome e la prima arma per far capire che variante Ã¨
                const armaPrincipale = unit.arma.split('/')[0].split(',')[0].trim();
                option.textContent = `${unit.nome} [${armaPrincipale}]`;
                select.appendChild(option);
            });
        };

        window.roster = [];
        
        // --- AGGIUNGI UNITÃ€ DAL DATABASE ---
        window.addUnitFromDB = async () => {
            const select = document.getElementById('dbSelect');
            const aliasInput = document.getElementById('unitAlias').value.toUpperCase().trim();
            const idProfilo = select.value;

            if (!idProfilo || !aliasInput) {
                alert("Seleziona una truppa e assegnagli un Soprannome!");
                return;
            }

            // Trova il profilo completo nel Master Database
            const dbUnit = window.masterNomadsDatabase.find(u => u.id_profilo === idProfilo);

            const unit = { 
                alias: aliasInput, 
                name: dbUnit.nome, 
                weapon: dbUnit.arma, 
                bs: dbUnit.bs,
                cc: dbUnit.cc,
                wip: dbUnit.wip,
                arm: dbUnit.arm,
                skills: dbUnit.skills,
                state: "ACTIVE", 
                player: "G_NOMADS", 
                modifiers: [] 
            };
            
            await setDoc(doc(db, "sessione_corrente", aliasInput), unit);
            window.roster.push(unit);
            
            document.getElementById('localRoster').innerText = `UnitÃ  caricate: ${window.roster.map(u => u.alias).join(', ')}`;
            document.getElementById('unitAlias').value = ""; // Svuota il campo
        };

        window.startBattle = () => { 
            if(window.roster.length === 0) alert("Nessuna unitÃ  schierata, ma accendo i sistemi.");
            document.getElementById('setup').style.display='none'; 
            document.getElementById('battle').style.display='block'; 
        };

        // --- IA VOCALE E CALCOLO DANNI ---
        const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.lang = 'it-IT';

        document.getElementById('btnListen').onclick = () => recognition.start();
        recognition.onstart = () => document.getElementById('btnListen').classList.add('recording');
        
        recognition.onresult = async (event) => {
            document.getElementById('btnListen').classList.remove('recording');
            const testo = event.results[0][0].transcript.toLowerCase();
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerText = `> Hai detto: "${testo}"\n` + consoleDiv.innerText;
            
            elaboraComando(testo);
        };

        async function elaboraComando(testo) {
            const match = window.roster.find(u => testo.includes(u.alias.toLowerCase()));
            const consoleDiv = document.getElementById('console');

            if (match) {
                let newState = "";
                let logMsg = "";

                // 1. GESTIONE DANNI E ARMATURA
                if (testo.includes("colpito") || testo.includes("danno") || testo.includes("salvezza")) {
                    logMsg = `\n[ALLERTA] ${match.alias} SOTTO ATTACCO!\n` + 
                             `>>> Calcolo Difesa: ARM ${match.arm} \n` +
                             `>>> Skills Attive: ${match.skills}`;
                }
                
                // 2. GESTIONE STATI
                else if (testo.includes("morto") || testo.includes("eliminato")) {
                    newState = "DEAD";
                    logMsg = `\n[STATUS] ${match.alias} KIA (Ucciso In Azione).`;
                } 
                else if (testo.includes("inconscio") || testo.includes("a terra")) {
                    newState = "UNCONSCIOUS";
                    logMsg = `\n[STATUS] ${match.alias} Inconscio. Richiesto intervento Medico (WIP bersaglio: ${match.wip}).`;
                } 
                else if (testo.includes("attivo") || testo.includes("curato")) {
                    newState = "ACTIVE";
                    logMsg = `\n[STATUS] ${match.alias} di nuovo Operativo.`;
                }

                // Esegue l'aggiornamento
                if (newState) {
                    await updateDoc(doc(db, "sessione_corrente", match.alias), { state: newState });
                }
                if (logMsg) {
                    consoleDiv.innerText = logMsg + "\n" + consoleDiv.innerText;
                }
            } else {
                consoleDiv.innerText = "\n[ERRORE] Nessun Alias riconosciuto nel comando.\n" + consoleDiv.innerText;
            }
        }
    </script>
</body>
</html>
