<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOMADS TACTICAL TERMINAL v8.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#A60000">

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    <script src="nomads_db.js"></script>

    <style>
        :root {
            --bg-color: #0b0c10; --panel-bg: #1f1f1f; --nomad-red: #cc0000; 
            --nomad-darkred: #8b0000; --nomad-orange: #ff6600; 
            --text-main: #f0f0f0; --text-dim: #aaaaaa;
        }
        body { background: var(--bg-color); color: var(--text-main); font-family: 'Share Tech Mono', monospace; padding: 15px; border: 2px solid var(--nomad-red); min-height: 100vh; box-sizing: border-box; margin: 0; }
        h2 { font-family: 'Teko', sans-serif; font-size: 28px; color: #fff; text-shadow: 2px 2px 0px var(--nomad-red); text-align: center; text-transform: uppercase; border-bottom: 2px solid var(--nomad-red); padding-bottom: 10px; margin-top: 0; }
        .section { background: var(--panel-bg); border-left: 4px solid var(--nomad-red); padding: 15px; margin-bottom: 20px; box-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        input, select { background: #000; color: var(--text-main); border: 1px solid var(--nomad-red); width: 100%; padding: 10px; margin: 5px 0; font-size: 14px; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--nomad-orange); outline: none; }
        button { width: 100%; padding: 12px; margin-top: 5px; cursor: pointer; font-family: 'Teko', sans-serif; font-size: 20px; font-weight: bold; text-transform: uppercase; border: none; transition: 0.3s; }
        .btn-nomad { background: linear-gradient(135deg, var(--nomad-red) 0%, var(--nomad-darkred) 100%); color: #fff; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%); }
        .btn-nomad:hover { background: var(--nomad-orange); color: #000; }
        .btn-status { background: #222; color: var(--nomad-red); border: 1px solid var(--nomad-red); margin-top: 15px; font-size: 18px; }
        .btn-small { padding: 8px; font-size: 16px; margin-top: 5px; clip-path: none; border-radius: 3px; }
        
        .recording { background: #ff0000 !important; color: white !important; animation: blink 1s infinite; box-shadow: 0 0 20px var(--nomad-orange); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #console { font-size: 13px; margin-top: 20px; color: var(--text-main); background: #050505; padding: 15px; border: 1px solid var(--nomad-red); border-left: 5px solid var(--nomad-orange); height: 200px; overflow-y: auto; white-space: pre-wrap; line-height: 1.4; }
        .highlight { color: var(--nomad-orange); font-weight: bold; }
        .alert { color: var(--nomad-red); font-weight: bold; }
        .success { color: #00ff00; font-weight: bold; }
        
        .roster-list { font-size: 12px; margin-top: 15px; border-top: 1px dashed var(--nomad-red); padding-top: 10px; }
        .roster-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); padding: 8px; margin-bottom: 5px; border-left: 2px solid var(--nomad-orange); }
        .del-btn { color: var(--nomad-red); font-weight: bold; cursor: pointer; padding: 5px 10px; background: #222; border-radius: 3px; }
        .flex-row { display: flex; gap: 10px; }

        /* WIZARD UI */
        #wizardPanel { background: #111; border: 2px solid var(--nomad-orange); padding: 15px; margin-top: 10px; text-align: center; }
        #wizStep { font-size: 22px; font-family: 'Teko', sans-serif; color: var(--nomad-orange); font-weight: bold; }
        #wizDesc { font-size: 12px; color: #aaa; margin-top: 5px; }
        #wizData { font-size: 14px; color: #fff; margin-top: 10px; border-top: 1px dashed #444; padding-top: 10px; }
    </style>
</head>
<body>
    <h2>-- TUNGUSKA DATANET --</h2>
    
    <div id="setup">
        <div class="section">
            <h3 style="margin-top:0; font-size: 16px; color: var(--nomad-orange);">ARCHIVIO SQUADRE</h3>
            <div class="flex-row">
                <select id="savedRostersSelect" style="flex: 2;"><option value="">-- SQUADRE SALVATE --</option></select>
                <button class="btn-nomad btn-small" style="flex: 1;" onclick="loadRoster()">CARICA</button>
            </div>
            <div class="flex-row">
                <input type="text" id="saveName" placeholder="NOME NUOVA SQUADRA" style="flex: 2;">
                <button class="btn-nomad btn-small" style="flex: 1;" onclick="saveRoster()">SALVA</button>
            </div>
        </div>

        <div class="section">
            <h3 style="margin-top:0; font-size: 16px; color: var(--nomad-orange);">SCHIERAMENTO TRUPPE</h3>
            <select id="groupSelect" onchange="updateProfileSelect()"><option value="">-- 1. SELEZIONA TRUPPA --</option></select>
            <select id="profileSelect" disabled><option value="">-- 2. SELEZIONA PROFILO --</option></select>
            <input type="text" id="unitAlias" placeholder="3. ASSEGNA SOPRANNOME (Opzionale)">
            <button class="btn-nomad" onclick="addUnitToRoster()">AGGIUNGI</button>
            <div id="localRoster" class="roster-list"><i>Nessuna unit√† schierata.</i></div>
        </div>
        <button class="btn-status" onclick="startBattle()">INVIA DATI E INIZIA PARTITA</button>
    </div>

    <div id="battle" style="display:none;">
        <button id="btnListen" class="btn-nomad" style="padding: 15px; font-size: 22px;">üé§ INIZIA PROTOCOLLO A FASI</button>
        
        <div id="wizardPanel">
            <div id="wizStep">STANDBY</div>
            <div id="wizDesc">Premi il pulsante per iniziare l'ordine sequenziale.</div>
            <div id="wizData"></div>
        </div>

        <div id="console"><span class="highlight">[LOG DI SISTEMA]:</span> Modulo Tattico Online.</div>
        <button class="btn-status btn-small" onclick="location.reload()" style="margin-top: 20px;">TORNA AL SETUP</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // FIREBASE CONFIG - Inserisci i tuoi dati!
        const firebaseConfig = { apiKey: "IL_TUO_API", projectId: "IL_TUO_PROGETTO" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.roster = [];
        window.customDictionary = JSON.parse(localStorage.getItem('infinityDictionary_Nomads') || '{}');

        // --- SETUP ROSTER E INTERFACCIA ---
        window.onload = () => {
            if(!window.masterNomadsDatabase) return;
            const gruppiUnici = [...new Set(window.masterNomadsDatabase.map(u => u.nome.trim()))].sort();
            const groupSelect = document.getElementById('groupSelect');
            gruppiUnici.forEach(nome => {
                const opt = document.createElement('option'); opt.value = nome; opt.textContent = nome; groupSelect.appendChild(opt);
            });
            refreshSavedRostersList();
        };

        window.updateProfileSelect = () => {
            const groupName = document.getElementById('groupSelect').value;
            const profileSelect = document.getElementById('profileSelect');
            profileSelect.innerHTML = '<option value="">-- 2. SELEZIONA PROFILO --</option>';
            profileSelect.disabled = !groupName;
            if (groupName) {
                window.masterNomadsDatabase.filter(u => u.nome.trim() === groupName).forEach(unit => {
                    const arma = unit.arma.split('/')[0].split(',')[0].trim();
                    const opt = document.createElement('option'); opt.value = unit.id_profilo; opt.textContent = `[${arma}] - BS:${unit.bs} ARM:${unit.arm}`;
                    profileSelect.appendChild(opt);
                });
            }
        };

        window.addUnitToRoster = () => {
            const idProfilo = document.getElementById('profileSelect').value;
            let aliasInput = document.getElementById('unitAlias').value.toUpperCase().trim();
            if (!idProfilo) return alert("Seleziona un profilo!");
            
            const dbUnit = window.masterNomadsDatabase.find(u => u.id_profilo === idProfilo);
            if (!aliasInput) aliasInput = dbUnit.nome.toUpperCase().trim();
            if (window.roster.some(u => u.alias === aliasInput)) return alert(`Hai gi√† schierato "${aliasInput}". Aggiungi un soprannome!`);

            const unit = { alias: aliasInput, name: dbUnit.nome, weapon: dbUnit.arma, bs: dbUnit.bs, cc: dbUnit.cc, wip: dbUnit.wip, arm: dbUnit.arm, skills: dbUnit.skills, state: "ACTIVE", player: "G_NOMADS", modifiers: [] };
            window.roster.push(unit); document.getElementById('unitAlias').value = ""; renderRoster();
        };

        window.removeUnit = (index) => { window.roster.splice(index, 1); renderRoster(); };
        window.renderRoster = () => {
            const container = document.getElementById('localRoster');
            if(window.roster.length === 0) return container.innerHTML = "<i>Nessuna unit√† schierata.</i>";
            container.innerHTML = "<div style='color:var(--nomad-orange); margin-bottom:5px;'>UNIT√Ä PRONTE:</div>";
            window.roster.forEach((u, i) => {
                const armaCorta = u.weapon.split('/')[0].split(',')[0];
                container.innerHTML += `<div class="roster-item"><div><b>${u.alias}</b> <span style="color:#aaa; font-size:10px;">| [${armaCorta}]</span></div><div class="del-btn" onclick="removeUnit(${i})">X</div></div>`;
            });
        };

        window.saveRoster = () => {
            const name = document.getElementById('saveName').value.trim().toUpperCase();
            if(!name || window.roster.length === 0) return alert("Inserisci nome e unit√†!");
            const savedData = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}');
            savedData[name] = window.roster; localStorage.setItem('infinityRosters_Nomads', JSON.stringify(savedData));
            document.getElementById('saveName').value = ""; refreshSavedRostersList();
        };
        window.loadRoster = () => {
            const name = document.getElementById('savedRostersSelect').value;
            if(!name) return;
            window.roster = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}')[name] || []; renderRoster();
        };
        window.refreshSavedRostersList = () => {
            const savedData = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}');
            const select = document.getElementById('savedRostersSelect');
            select.innerHTML = '<option value="">-- SQUADRE SALVATE --</option>';
            Object.keys(savedData).forEach(n => { const opt = document.createElement('option'); opt.value = n; opt.textContent = n; select.appendChild(opt); });
        };

        window.startBattle = async () => { 
            if(window.roster.length === 0) return alert("Aggiungi un'unit√†!");
            document.getElementById('setup').style.display='none'; document.getElementById('battle').style.display='block'; 
            for (let unit of window.roster) await setDoc(doc(db, "sessione_corrente", unit.alias), unit);
        };

        // ==========================================
        // MACCHINA A STATI DEL WIZARD VOCALE
        // ==========================================
        let wizState = "IDLE"; 
        let wizData = { unit: null, action: "", mods: "" };

        const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.lang = 'it-IT';
        
        function updateUI(step, desc, dataHtml) {
            document.getElementById('wizStep').innerText = step;
            document.getElementById('wizDesc').innerText = desc;
            document.getElementById('wizData').innerHTML = dataHtml;
        }

        document.getElementById('btnListen').onclick = () => {
            if (wizState === "IDLE") {
                wizState = "UNIT";
                wizData = { unit: null, action: "", mods: "" };
                updateUI("1. CHI SI ATTIVA?", "Pronuncia il NOME della truppa (Es. Gator, Alguacil...)", "");
                recognition.start();
            } else {
                // Tasto funziona da Annulla se il wizard √® in corso
                recognition.stop();
                wizState = "IDLE";
                updateUI("STANDBY", "Ordine annullato. Premi per ricominciare.", "");
                document.getElementById('btnListen').classList.remove('recording');
            }
        };
        
        recognition.onstart = () => document.getElementById('btnListen').classList.add('recording');
        
        recognition.onresult = async (event) => {
            document.getElementById('btnListen').classList.remove('recording');
            let testo = event.results[0][0].transcript.toLowerCase().trim();

            // Applica il dizionario per sicurezza
            const chiaviOrdinate = Object.keys(window.customDictionary).sort((a, b) => b.length - a.length);
            chiaviOrdinate.forEach(wrongPhrase => {
                testo = testo.replace(new RegExp(`\\b${wrongPhrase}\\b`, 'g'), window.customDictionary[wrongPhrase]);
            });

            if (wizState === "UNIT") {
                const match = window.roster.find(u => testo.includes(u.alias.toLowerCase()));
                if (match) {
                    wizData.unit = match;
                    wizState = "ACTION";
                    updateUI("2. AZIONE?", "Cosa fa? (Spara, Salva, Mischia, Muore, Curato...)", `<span style='color:var(--nomad-orange)'>UNIT√Ä SELEZIONATA: ${match.alias}</span>`);
                    setTimeout(() => recognition.start(), 800); // Riapre il microfono da solo
                } else {
                    wizState = "IDLE";
                    updateUI("ERRORE NOME", `Non ho trovato "${testo}" in squadra. Riprova.`, "");
                }
            } 
            else if (wizState === "ACTION") {
                wizData.action = testo;
                let dataHtml = `<span style='color:var(--nomad-orange)'>UNIT√Ä: ${wizData.unit.alias} <br> AZIONE: ${testo.toUpperCase()}</span>`;
                
                // Se √® un cambio di stato diretto (morto, inconscio), saltiamo i modificatori!
                if (testo.includes("morto") || testo.includes("eliminato") || testo.includes("inconscio") || testo.includes("a terra") || testo.includes("curato")) {
                    wizState = "IDLE";
                    updateUI("STANDBY", "Applicazione stato in corso...", dataHtml);
                    elaboraOrdineFinale(wizData);
                } else {
                    wizState = "MODS";
                    updateUI("3. VARIABILI E DISTANZA", "Es. Ottima, Copertura, Mimetismo... (oppure d√¨ 'Nessuno')", dataHtml);
                    setTimeout(() => recognition.start(), 800);
                }
            } 
            else if (wizState === "MODS") {
                wizData.mods = testo;
                wizState = "IDLE";
                updateUI("STANDBY", "Ordine in elaborazione.", `<span style='color:var(--nomad-orange)'>UNIT√Ä: ${wizData.unit.alias} <br> AZIONE: ${wizData.action.toUpperCase()} <br> VARIABILI: ${testo.toUpperCase()}</span>`);
                elaboraOrdineFinale(wizData);
            }
        };

        function printLog(msg) {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML = msg + "\n\n" + consoleDiv.innerHTML;
        }

        async function elaboraOrdineFinale(data) {
            const match = data.unit;
            const azione = data.action;
            const variabili = data.mods;
            let logHTML = `> <span style="color:#aaa">ORDINE: [${match.alias}] - [${azione}] - [${variabili}]</span><br>`;

            let mods = [], base = 0, isCalculated = false;

            // Calcolo Attacco a distanza
            if (azione.includes("spara") || azione.includes("fuoco") || azione.includes("attacca")) {
                logHTML += `<span class="highlight">[ATTACCO - BS]</span> ${match.alias}<br>`;
                base = match.bs;
                if (variabili.includes("copertura") || variabili.includes("riparo")) mods.push({nome: "Copertura Bersaglio", val: -3});
                if (variabili.includes("mimetismo") || variabili.includes("mimetico")) mods.push({nome: "Mimetismo", val: -3});
                if (variabili.includes("ottima") || variabili.includes("buona")) mods.push({nome: "Gittata Ideale", val: +3});
                if (variabili.includes("lunga") || variabili.includes("cattiva")) mods.push({nome: "Gittata Lunga", val: -3});
                isCalculated = true;
            }
            // Calcolo Mischia
            else if (azione.includes("corpo a corpo") || azione.includes("mischia")) {
                logHTML += `<span class="highlight">[MISCHIA - CC]</span> ${match.alias}<br>`;
                base = match.cc;
                if (match.skills.includes("Martial Arts")) mods.push({nome: "Arti Marziali", val: +3});
                isCalculated = true;
            }
            // Calcolo Tiro Salvezza (Danni)
            else if (azione.includes("salva") || azione.includes("colpito") || azione.includes("armatura")) {
                logHTML += `<span class="alert">[DIFESA - ARM]</span> ${match.alias}<br>`;
                base = match.arm;
                if (variabili.includes("copertura") || variabili.includes("riparo")) mods.push({nome: "Copertura", val: +3});
                isCalculated = true;
            }

            // Esecuzione matematica a schermo
            if (isCalculated) {
                logHTML += `Base: <b>${base}</b><br>`;
                let modTotal = 0;
                mods.forEach(m => { modTotal += m.val; logHTML += `> ${m.nome}: <span style="color:${m.val > 0 ? '#00ff00' : '#ff3333'}">${m.val > 0 ? '+' : ''}${m.val}</span><br>`; });
                logHTML += `-----------------------<br><span class="highlight">>>> OBIETTIVO FINALE: ${base + modTotal} <<<</span><br>`;
                logHTML += `<span style="font-size:10px; color:var(--text-dim);">Abilit√† Base: ${match.skills}</span>`;
            }

            // Modifica Stato Firebase
            let newState = "";
            if (azione.includes("morto") || azione.includes("eliminato")) { newState = "DEAD"; logHTML += `<br><span class="alert">[STATUS] ${match.alias} KIA.</span>`; } 
            else if (azione.includes("inconscio") || azione.includes("a terra")) { newState = "UNCONSCIOUS"; logHTML += `<br><span class="alert">[STATUS] ${match.alias} Inconscio (WIP Medico: ${match.wip}).</span>`; } 
            else if (azione.includes("attivo") || azione.includes("curato")) { newState = "ACTIVE"; logHTML += `<br><span class="success">[STATUS] ${match.alias} Operativo.</span>`; }

            if (newState) await updateDoc(doc(db, "sessione_corrente", match.alias), { state: newState });
            
            printLog(logHTML);
        }
    </script>
</body>
</html>
