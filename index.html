window.executeCalculation = () => {
            const order = window.currentOrder;
            let base = 0; let attrName = ""; let modTotal = 0; let modLog = "";

            const unitSkills = order.unit.skills.toLowerCase();
            const targetSkills = order.target ? order.target.skills.toLowerCase() : "";

            if (order.action.includes('ATTACCO BS')) { 
                base = order.unit.bs; attrName = "BS"; 
                if(window.manualCover) { modTotal -= 3; modLog += `> Copertura Bersaglio: <b style="color:#ff3333;">-3</b><br>`; }
                
                let dist = window.manualDistance;
                let rangeMod = (dist <= 16) ? +3 : (dist <= 32 ? -3 : -6);
                modTotal += rangeMod;
                modLog += `> Gittata Arma (${dist}"): <b style="color:${rangeMod>0?'#00ff00':'#ff3333'};">${rangeMod>0?'+':''}${rangeMod}</b><br>`;
                
                if(targetSkills.includes("mimetism (-6)")) { modTotal -= 6; modLog += `> Mimetismo (Avversario): <b style="color:#ff3333;">-6</b><br>`; }
                else if(targetSkills.includes("mimetism (-3)") || targetSkills.includes("camouflage")) { modTotal -= 3; modLog += `> Mimetismo (Avversario): <b style="color:#ff3333;">-3</b><br>`; }
            }
            else if (order.action.includes('CORPO A CORPO')) { 
                base = order.unit.cc; attrName = "CC"; 
                if(unitSkills.includes("martial arts")) { modTotal += 3; modLog += `> Arti Marziali: <b style="color:#00ff00;">+3</b><br>`; }
            }
            else if (order.action.includes('TIRO SALVEZZA')) { 
                base = order.unit.arm; attrName = "ARM"; 
                if(window.manualCover) { modTotal += 3; modLog += `> Bonus Copertura: <b style="color:#00ff00;">+3</b><br>`; }
            }
            else if (order.action.includes('HACKING')) { 
                base = order.unit.wip; attrName = "WIP"; 
                if(targetSkills.includes("tinbot: firewall (-6)")) { modTotal -= 6; modLog += `> Firewall Pesante: <b style="color:#ff3333;">-6</b><br>`; }
                else if(targetSkills.includes("tinbot: firewall (-3)") || targetSkills.includes("ecm: hacker (-3)")) { modTotal -= 3; modLog += `> ECM/Firewall: <b style="color:#ff3333;">-3</b><br>`; }
            }

            let target = base + modTotal;
            let targetName = order.target ? order.target.nome : "Nessuno/Ignoto";

            let resHtml = `<div style="color:#fff; line-height:1.6;">
                           <b>ATTACCANTE:</b> ${order.unit.alias}<br>
                           <b>BERSAGLIO:</b> ${targetName}<br>
                           <br><b>BASE (${attrName}):</b> ${base}<br>
                           ${modLog}
                           <hr style="border-color:var(--nomad-orange);">
                           <div style="font-size:32px; color:#00ff00; font-weight:bold; text-align:center;">TARGET: ${target}</div>
                           </div>`;

            const resBox = document.getElementById('calc-result');
            resBox.innerHTML = resHtml; resBox.style.display = 'block';
        };
