// 13.1 modificato grafica range e assegnazione b
// 14.1 aggiunto vai programmi hacker
//15.1 aggiunto gittata armi variabile in base all'arma selezionata
//16.1 creato lista armi esterna
//17.1 inserito valori completi arma 
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOMADS TACTICAL TERMINAL v17.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#A60000">

    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    <script src="nomads_db.js"></script>
<script src="weapons_db.js"></script>


    <style>
        html { overscroll-behavior: none; }
        :root {
            --bg-color: #0b0c10; --panel-bg: #1f1f1f; --nomad-red: #cc0000; 
            --nomad-darkred: #8b0000; --nomad-orange: #ff6600; 
            --text-main: #f0f0f0; --text-dim: #aaaaaa;
        }
        body { background: var(--bg-color); color: var(--text-main); font-family: 'Share Tech Mono', monospace; padding: 10px; border: 2px solid var(--nomad-red); min-height: 100vh; box-sizing: border-box; margin: 0; display: flex; flex-direction: column; overscroll-behavior-y: none; touch-action: pan-x pan-y; }
        h2 { font-family: 'Teko', sans-serif; font-size: 28px; color: #fff; text-shadow: 2px 2px 0px var(--nomad-red); text-align: center; text-transform: uppercase; border-bottom: 2px solid var(--nomad-red); padding-bottom: 5px; margin-top: 0; margin-bottom: 15px;}
        
        .section { background: var(--panel-bg); border-left: 4px solid var(--nomad-red); padding: 10px; margin-bottom: 10px; box-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        input, select { background: #000; color: var(--text-main); border: 1px solid var(--nomad-red); width: 100%; padding: 15px; margin: 5px 0; font-size: 16px; box-sizing: border-box; }
        
        .btn-nomad { width: 100%; background: linear-gradient(135deg, var(--nomad-red) 0%, var(--nomad-darkred) 100%); color: #fff; padding: 15px; margin-top: 5px; cursor: pointer; font-family: 'Teko', sans-serif; font-size: 22px; font-weight: bold; text-transform: uppercase; border: none; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%); }
        .btn-status { width: 100%; background: #222; color: var(--nomad-red); border: 2px solid var(--nomad-red); padding: 15px; margin-top: 15px; font-family: 'Teko', sans-serif; font-size: 22px; font-weight: bold; cursor: pointer; }
        .btn-small { padding: 10px; font-size: 18px; margin-top: 5px; clip-path: none; border-radius: 3px; }
        
        .grid-buttons { display: flex; flex-direction: column; gap: 10px; flex-grow: 1; overflow-y: auto; padding-bottom: 10px;}
        .huge-btn { flex: 1; min-height: 80px; background: #1a0000; border: 2px solid var(--nomad-red); color: #fff; font-family: 'Teko', sans-serif; font-size: 32px; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; transition: 0.2s; border-radius: 5px; padding: 10px; text-align: center; line-height: 1.1; }
        .huge-btn:active { background: var(--nomad-orange); color: #000; transform: scale(0.98); }
        .huge-btn span { font-family: 'Share Tech Mono', monospace; font-size: 14px; color: var(--nomad-orange); font-weight: normal; margin-top: 5px; }

        .flex-row { display: flex; gap: 10px; align-items: center; }
        .step-container { display: none; flex-direction: column; height: 100%; flex-grow: 1;}
        .active-step { display: flex; }
        
        #battle-header { text-align: center; color: var(--nomad-orange); font-size: 18px; font-weight: bold; margin-bottom: 10px; padding: 10px; background: #222; border: 1px dashed var(--nomad-orange); }
        .roster-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); padding: 8px; margin-bottom: 5px; border-left: 2px solid var(--nomad-orange); font-size: 12px; }
        .del-btn { color: var(--nomad-red); font-weight: bold; cursor: pointer; padding: 5px 10px; background: #222; border-radius: 3px; }
        
        #calc-result { margin-top:15px; font-size:16px; border:2px solid #00ff00; background:#001a00; padding:15px; display:none; box-shadow: 0 0 15px rgba(0,255,0,0.2); }

        /* Stile per Barra Gittate e Burst (B) */
        .range-bar { display: flex; width: 100%; height: 40px; border: 2px solid #fff; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .range-seg { display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; font-size: 18px; cursor: pointer; transition: 0.2s; opacity: 0.4; }
        .range-seg.active { opacity: 1; color: #fff; text-shadow: 1px 1px 2px #000; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .seg-1 { background: #4CAF50; flex: 1; } /* Positivi (+3) */
        .seg-2 { background: #03A9F4; flex: 1; } /* Neutri (0) */
        .seg-3 { background: #FFC107; flex: 1; } /* Negativi lievi (-3) */
        .seg-4 { background: #D32F2F; flex: 1; } /* Negativi gravi (-6) */
        
        .target-card { background: #111; border: 1px solid var(--nomad-orange); padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .burst-ctrl { display: flex; align-items: center; gap: 15px; background: #000; padding: 5px 15px; border-radius: 5px; border: 1px solid #444;}
        .burst-btn { background: var(--nomad-orange); color: #000; border: none; font-size: 24px; font-weight: bold; width: 40px; height: 40px; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding-bottom: 4px; }
    </style>
</head>
<body>

   <div style="position: relative;">
        <h2>-- NOMAD DATANET --</h2>
        <span style="position: absolute; right: 5px; bottom: 20px; font-size: 14px; font-family: 'Share Tech Mono', monospace; color: var(--nomad-orange); font-weight: bold; text-shadow: none; letter-spacing: normal;">v17.1</span>
    </div>
    
    <div id="setup">
        <div class="section">
            <h3 style="margin-top:0; color: var(--nomad-orange);">ARCHIVIO SQUADRE</h3>
            <div class="flex-row">
                <select id="savedRostersSelect" style="flex: 2;"><option value="">-- SQUADRE SALVATE --</option></select>
                <button class="btn-nomad btn-small" style="flex: 1;" onclick="loadRoster()">CARICA</button>
                <button class="btn-status btn-small" style="flex: 1; margin-top: 5px; padding: 10px;" onclick="deleteRoster()">ELIMINA</button>
            </div>
            <div class="flex-row">
                <input type="text" id="saveName" placeholder="NOME NUOVA SQUADRA" style="flex: 2;">
                <button class="btn-nomad btn-small" style="flex: 1;" onclick="saveRoster()">SALVA LISTA</button>
            </div>
        </div>

        <div class="section">
            <h3 style="margin-top:0; color: var(--nomad-orange);">SCHIERAMENTO TRUPPE</h3>
            <div class="flex-row">
                <select id="groupSelect" style="flex:2;" onchange="updateProfileSelect()"><option value="">-- 1. TRUPPA --</option></select>
                <select id="combatGroup" style="flex:1;"><option value="1">GRUPPO 1</option><option value="2">GRUPPO 2</option></select>
            </div>
            <select id="profileSelect" disabled><option value="">-- 2. SELEZIONA PROFILO --</option></select>
            <input type="text" id="unitAlias" placeholder="3. ASSEGNA SOPRANNOME (Opzionale)">
            <button class="btn-nomad" onclick="addUnitToRoster()">SCHIERA UNITÀ</button>
            <div id="localRoster" style="margin-top:10px; border-top:1px dashed red; padding-top:10px;"><i>Nessuna unità schierata.</i></div>
        </div>
        <button class="btn-status" onclick="startBattle()">INVIA DATI E INIZIA PARTITA</button>
    </div>

    <div id="battle" style="display:none; flex-grow: 1; flex-direction: column;">
        <div id="battle-header">SELEZIONA GRUPPO DI COMBATTIMENTO</div>

        <div id="step-group" class="step-container active-step">
            <div class="grid-buttons">
                <button class="huge-btn" onclick="goToStep('step-unit', 1)">GRUPPO 1 <br><span>(Ordini Principali)</span></button>
                <button class="huge-btn" onclick="goToStep('step-unit', 2)">GRUPPO 2 <br><span>(Ordini Secondari)</span></button>
            </div>
            <button class="btn-status" onclick="location.reload()" style="margin-top: 20px;">TORNA AL SETUP INIZIALE</button>
        </div>

        <div id="step-unit" class="step-container">
            <div class="grid-buttons" id="unit-buttons-container"></div>
            <button class="btn-status" onclick="goToStep('step-group')">INDIETRO</button>
        </div>

        <div id="step-action" class="step-container">
            <div class="grid-buttons" style="overflow-y:auto;">
                <button class="huge-btn" onclick="selectAction('MOVIMENTO')">MOVIMENTO <span>(Innesca ARO)</span></button>
                <button class="huge-btn" onclick="selectAction('ATTACCO BS')">ATTACCO BS <span>(Fuoco a Distanza)</span></button>
                <button class="huge-btn" onclick="selectAction('CORPO A CORPO')">CORPO A CORPO <span>(Mischia)</span></button>
                <button class="huge-btn" style="border-color:#00ffff;" onclick="selectAction('HACKING')">HACKING <span>(Attacco Infoguerra)</span></button>
                <button class="huge-btn" style="border-color:#00ffff;" onclick="selectAction('SCHIVATA')">SCHIVATA / DODGE <span>(Difesa)</span></button>
                <button class="huge-btn" style="border-color:#00ffff;" onclick="selectAction('TIRO SALVEZZA')">TIRO SALVEZZA <span>(Difesa Danni - ARM)</span></button>
                <button class="huge-btn" style="border-color: #aaa;" onclick="selectAction('GESTIONE STATI')">GESTIONE STATI <span>(Targato, Inconscio, Rimosso...)</span></button>
            </div>
            <button class="btn-status" onclick="goToStep('step-unit')">ANNULLA</button>
        </div>

        <div id="step-weapon" class="step-container">
            <div class="grid-buttons" id="weapon-buttons-container"></div>
            <button class="btn-status" onclick="goToStep('step-action')">INDIETRO</button>
        </div>

        <div id="step-wait-aro" class="step-container">
            <div class="grid-buttons" style="justify-content: flex-start;">
                <div style="text-align:center; padding: 15px; border: 2px dashed var(--nomad-orange); color: #fff; margin-bottom: 15px;">
                    <h1 style="color:var(--nomad-red); font-size:30px; margin:0;">FASE REATTIVA</h1>
                    <p style="font-size: 14px;">In attesa dell'avversario...</p>
                </div>
                
                <h3 style="color:var(--nomad-orange); margin:0;">SELEZIONA BERSAGLIO:</h3>
                <p style="font-size:12px; margin-top:0;">(Il sistema leggerà le sue abilità difensive automaticamente)</p>
                <select id="targetSelect" style="margin-bottom:20px;">
                    <option value="">-- SELEZIONA NEMICO (Simulazione) --</option>
                </select>

                <button class="huge-btn" style="background:#004400; border-color:#00ff00; min-height: 60px;" onclick="confirmAro()">PROSEGUI <br><span>(ARO Completato)</span></button>
            </div>
            <button class="btn-status" onclick="goToStep('step-group')">ANNULLA ORDINE</button>
        </div>

        <div id="step-second-half" class="step-container">
            <div class="grid-buttons" id="second-half-buttons-container">
                </div>
            <button class="btn-status" onclick="goToStep('step-group')">ABORTISCI ATTIVAZIONE</button>
        </div>

        <div id="step-modifiers" class="step-container">
            
            <div id="burst-header-ui" style="display:flex; justify-content:space-between; align-items:center; background:#222; padding:10px; border:1px solid var(--nomad-red); margin-bottom:10px;">
                <b style="color:#fff; font-size:20px;">BURST (B) TOTALE ARMA:</b>
                <div class="burst-ctrl">
                    <button class="burst-btn" onclick="adjustTotalBurst(-1)">-</button>
                    <span id="total-burst-display" style="color:#fff; font-size:24px; font-weight:bold;">3</span>
                    <button class="burst-btn" onclick="adjustTotalBurst(1)">+</button>
                </div>
            </div>

            <div id="targets-allocation-container" style="overflow-y:auto; flex-grow:1;">
                </div>

            <button id="add-target-btn" class="btn-status" style="margin-top:5px; border-style:dashed;" onclick="addNewTarget()">+ AGGIUNGI BERSAGLIO SECONDARIO</button>
            
            <button class="huge-btn" style="background:var(--nomad-orange); color:#000; margin-top:15px; min-height:60px;" onclick="executeCalculation()">ESEGUI CALCOLO FINALE</button>
            
            <div id="calc-result"></div>
            
            <button class="btn-status" style="margin-top:20px;" onclick="goToStep('step-group')">FINE ORDINE (TORNA AL MENU)</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "IL_TUO_API", projectId: "IL_TUO_PROGETTO" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        if(!window.masterWeaponsDatabase) {
            console.error("ATTENZIONE: File weapons_db.js non caricato!");
        }

        window.roster = [];
        window.currentOrder = { unit: null, action: "", weapon: "", target: null };
        window.manualCover = false;
        
        // --- GESTIONE MULTI-BERSAGLIO E BURST (B) ---
        window.totalBurst = 3;
        window.combatTargets = [];

        window.adjustTotalBurst = (val) => {
            window.totalBurst = Math.max(1, window.totalBurst + val);
            let currentAllocated = window.combatTargets.reduce((sum, t) => sum + t.burst, 0);
            if (currentAllocated > window.totalBurst) {
                for(let t of window.combatTargets) { if(t.burst > 0) { t.burst--; break; } }
            }
            document.getElementById('total-burst-display').innerText = window.totalBurst;
            renderTargetsAllocation();
        };

        window.adjustTargetBurst = (index, val) => {
            let currentAllocated = window.combatTargets.reduce((sum, t) => sum + t.burst, 0);
            let tgt = window.combatTargets[index];
            if (val > 0 && currentAllocated < window.totalBurst) { tgt.burst += 1; } 
            else if (val < 0 && tgt.burst > 0) { tgt.burst -= 1; }
            renderTargetsAllocation();
        };

        window.setTargetRange = (tgtIndex, bandIndex, mod) => { 
            window.combatTargets[tgtIndex].rangeIndex = bandIndex; 
            window.combatTargets[tgtIndex].rangeMod = mod; 
            renderTargetsAllocation(); 
        };
        window.toggleTargetCover = (index) => { window.combatTargets[index].cover = !window.combatTargets[index].cover; renderTargetsAllocation(); };

        window.addNewTarget = () => {
            let wpnBands = getWeaponBands(window.currentOrder.weapon);
            window.combatTargets.push({ id: "generic", name: "Bersaglio Aggiuntivo", skills: "", rangeIndex: 0, rangeMod: wpnBands[0].mod, burst: 0, cover: false });
            renderTargetsAllocation();
        };

        // Funzione per trovare il Profilo completo dell'Arma nel DB ESTERNO
        window.getWeaponProfile = (weaponName) => {
            if(!weaponName || !window.masterWeaponsDatabase) return window.masterWeaponsDatabase["DEFAULT"];
            let upperName = weaponName.toUpperCase();
            let matchedKey = Object.keys(window.masterWeaponsDatabase).find(k => upperName.includes(k));
            return matchedKey ? window.masterWeaponsDatabase[matchedKey] : window.masterWeaponsDatabase["DEFAULT"];
        };
        window.currentOrder = { unit: null, action: "", weapon: "", target: null };
        window.manualCover = false;
        window.manualDistance = 16;

        // --- SETUP ROSTER ---
        window.onload = () => {
            if(!window.masterNomadsDatabase) return;
            const gruppiUnici = [...new Set(window.masterNomadsDatabase.map(u => u.nome.trim()))].sort();
            const groupSelect = document.getElementById('groupSelect');
            gruppiUnici.forEach(nome => { const opt = document.createElement('option'); opt.value = nome; opt.textContent = nome; groupSelect.appendChild(opt); });
            
            const targetSelect = document.getElementById('targetSelect');
            window.masterNomadsDatabase.forEach(u => { const opt = document.createElement('option'); opt.value = u.id_profilo; opt.textContent = u.nome; targetSelect.appendChild(opt); });
            
            refreshSavedRostersList(); // Carica tendina salvataggi all'avvio
        };

        window.updateProfileSelect = () => {
            const groupName = document.getElementById('groupSelect').value;
            const profileSelect = document.getElementById('profileSelect');
            profileSelect.innerHTML = '<option value="">-- 2. SELEZIONA PROFILO --</option>';
            profileSelect.disabled = !groupName;
            if (groupName) {
                window.masterNomadsDatabase.filter(u => u.nome.trim() === groupName).forEach(unit => {
                    const opt = document.createElement('option'); opt.value = unit.id_profilo;
                    const arma = unit.arma.split('/')[0].split(',')[0].trim();
                    opt.textContent = `[${arma}] - BS:${unit.bs} ARM:${unit.arm}`;
                    profileSelect.appendChild(opt);
                });
            }
        };

        window.addUnitToRoster = () => {
            const idProfilo = document.getElementById('profileSelect').value;
            const cGroup = document.getElementById('combatGroup').value;
            let aliasInput = document.getElementById('unitAlias').value.toUpperCase().trim();
            if (!idProfilo) return;
            const dbUnit = window.masterNomadsDatabase.find(u => u.id_profilo === idProfilo);
            if (!aliasInput) aliasInput = dbUnit.nome.toUpperCase().trim();
            
            const unit = { alias: aliasInput, name: dbUnit.nome, weapon: dbUnit.arma, bs: dbUnit.bs, cc: dbUnit.cc, wip: dbUnit.wip, arm: dbUnit.arm, skills: dbUnit.skills, combatGroup: parseInt(cGroup), state: "ACTIVE", player: "G_NOMADS" };
            window.roster.push(unit); document.getElementById('unitAlias').value = ""; renderRoster();
        };

        window.removeUnit = (index) => { window.roster.splice(index, 1); renderRoster(); };
        window.renderRoster = () => {
            const container = document.getElementById('localRoster');
            if(window.roster.length === 0) return container.innerHTML = "<i>Nessuna unità schierata.</i>";
            container.innerHTML = "";
            window.roster.forEach((u, i) => {
                const armaCorta = u.weapon.split('/')[0].split(',')[0];
                container.innerHTML += `<div class="roster-item"><div><b style="color:#00ff00;">[G${u.combatGroup}]</b> <b>${u.alias}</b> <span style="color:#aaa;">| ${armaCorta}</span></div><div class="del-btn" onclick="removeUnit(${i})">X</div></div>`;
            });
        };

        // --- GESTIONE ARCHIVIO SQUADRE (SALVA / CARICA / ELIMINA) ---
        window.saveRoster = () => {
            const name = document.getElementById('saveName').value.trim().toUpperCase();
            if(!name || window.roster.length === 0) return alert("Inserisci un nome valido e aggiungi almeno un'unità alla lista!");
            
            const savedData = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}');
            savedData[name] = window.roster;
            localStorage.setItem('infinityRosters_Nomads', JSON.stringify(savedData));
            
            document.getElementById('saveName').value = "";
            refreshSavedRostersList();
            alert(`Squadra "${name}" salvata con successo!`);
        };

        window.loadRoster = () => {
            const name = document.getElementById('savedRostersSelect').value;
            if(!name) return;
            
            const loadedRoster = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}')[name] || [];
            
            window.roster = loadedRoster.map(u => ({
                ...u,
                combatGroup: u.combatGroup || 1,
                state: u.state || "ACTIVE"
            }));
            
            renderRoster();
        };

        window.deleteRoster = () => {
            const name = document.getElementById('savedRostersSelect').value;
            if(!name) return alert("Seleziona una squadra dalla tendina prima di eliminarla.");
            
            if(confirm(`Sei sicuro di voler eliminare la squadra salvata "${name}"?`)) {
                const savedData = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}');
                delete savedData[name];
                localStorage.setItem('infinityRosters_Nomads', JSON.stringify(savedData));
                refreshSavedRostersList();
            }
        };

        window.refreshSavedRostersList = () => {
            const savedData = JSON.parse(localStorage.getItem('infinityRosters_Nomads') || '{}');
            const select = document.getElementById('savedRostersSelect');
            select.innerHTML = '<option value="">-- SQUADRE SALVATE --</option>';
            Object.keys(savedData).forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                select.appendChild(opt);
            });
        };

        // --- MACCHINA A STATI ---
        window.startBattle = async () => { 
            if(window.roster.length === 0) return alert("Schiera un'unità!");
            document.getElementById('setup').style.display='none'; document.getElementById('battle').style.display='flex'; 
        };

        window.goToStep = (stepId, param = null) => {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active-step'));
            document.getElementById(stepId).classList.add('active-step');
            const header = document.getElementById('battle-header');

            if (stepId === 'step-group') header.innerText = "GRUPPO DI COMBATTIMENTO";
            if (stepId === 'step-unit') {
                header.innerText = `UNITÀ - GRUPPO ${param}`;
                const container = document.getElementById('unit-buttons-container'); container.innerHTML = "";
                const unitsInGroup = window.roster.filter(u => u.combatGroup === param);
                unitsInGroup.forEach(u => {
                    let btnColor = u.state === 'DEAD' ? '#330000' : '#1a0000';
                    container.innerHTML += `<button class="huge-btn" style="background:${btnColor};" onclick="selectUnit('${u.alias}')">${u.alias}</button>`;
                });
            }
        };

        window.selectUnit = (alias) => { window.currentOrder.unit = window.roster.find(u => u.alias === alias); goToStep('step-action'); };
        
        window.selectAction = (action) => {
            window.currentOrder.action = action;
            if (action === 'GESTIONE STATI') { 
                document.getElementById('battle-header').innerText = `STATO DI: ${window.currentOrder.unit.alias}`; 
                goToStep('step-states'); 
            }
            else if (action === 'TIRO SALVEZZA') { goToModifiers('TIRO SALVEZZA'); }
            else if (action === 'ATTACCO BS') {
                document.getElementById('battle-header').innerText = "SELEZIONA ARMA";
                const container = document.getElementById('weapon-buttons-container');
                container.innerHTML = "";
                window.currentOrder.unit.weapon.replace('/', ',').split(',').forEach(w => {
                    container.innerHTML += `<button class="huge-btn" onclick="declareAttack('${w.trim()}')">${w.trim()}</button>`;
                });
                goToStep('step-weapon');
            } 
            else if (action === 'HACKING') {
                document.getElementById('battle-header').innerText = "SELEZIONA PROGRAMMA HACKING";
                const container = document.getElementById('weapon-buttons-container');
                container.innerHTML = "";
                // Lista dei programmi standard N4
                const programs = [
                    { name: "SPOTLIGHT", desc: "+3 WIP (Applica: TARGATO)" },
                    { name: "CARBONITE", desc: "+0 WIP (Applica: IMM-A)" },
                    { name: "OBLIVION", desc: "+0 WIP (Applica: ISOLATO)" },
                    { name: "TRINITY", desc: "+3 WIP (Anti-Hacker)" }
                ];
                programs.forEach(p => {
                    container.innerHTML += `<button class="huge-btn" style="border-color:#00ffff;" onclick="declareHacking('${p.name}')">${p.name} <br><span style="color:#00ffff;">${p.desc}</span></button>`;
                });
                goToStep('step-weapon');
            }
            else if (action === 'CORPO A CORPO' || action === 'MOVIMENTO') { 
                goToStep('step-wait-aro');
            } 
        };

        window.declareAttack = (weaponName) => { window.currentOrder.weapon = weaponName; goToStep('step-wait-aro'); };
        
        window.declareHacking = (programName) => { 
            window.currentOrder.weapon = programName; // Salviamo il programma come se fosse un'arma
            document.getElementById('battle-header').innerText = "ATTACCO INFO - IN ATTESA ARO";
            goToStep('step-wait-aro'); 
        };

        window.confirmAro = () => {
            const targetId = document.getElementById('targetSelect').value;
            if(targetId) { window.currentOrder.target = window.masterNomadsDatabase.find(u => u.id_profilo === targetId); } 
            else { window.currentOrder.target = null; }
            
            // GENERAZIONE DINAMICA SECONDA META' DELL'ORDINE
            const container = document.getElementById('second-half-buttons-container');
            container.innerHTML = "";
            const firstAction = window.currentOrder.action;

            if (firstAction === 'MOVIMENTO') {
                // Se mi sono mosso per primo, posso fare quasi tutto come seconda metà
                container.innerHTML += `<button class="huge-btn" onclick="selectAction('ATTACCO BS')">ATTACCO BS <span>(Seconda Metà)</span></button>`;
                container.innerHTML += `<button class="huge-btn" onclick="goToModifiers('CORPO A CORPO')">CORPO A CORPO <span>(Seconda Metà)</span></button>`;
                container.innerHTML += `<button class="huge-btn" onclick="goToModifiers('HACKING')">HACKING <span>(Seconda Metà)</span></button>`;
                container.innerHTML += `<button class="huge-btn" onclick="goToModifiers('SCHIVATA')">SCHIVATA <span>(Dodge)</span></button>`;
                container.innerHTML += `<button class="huge-btn" style="border-color: #aaa;" onclick="goToStep('step-group')">MOVIMENTO <span>(Fine Attivazione)</span></button>`;
            } 
            else {
                // Se la prima metà è stata un attacco, un hack, ecc., la seconda metà PUÒ ESSERE SOLO MOVIMENTO
                container.innerHTML += `<button class="huge-btn" style="border-color: #aaa;" onclick="goToModifiers('${firstAction}')">MOVIMENTO <span>(Esegui Calcolo dell'Attacco)</span></button>`;
                container.innerHTML += `<p style="color:#aaa; text-align:center; font-size:14px; padding:10px;">Regole: Hai già dichiarato un'abilità di attacco/tiro nella prima metà dell'ordine. Puoi solo muoverti.</p>`;
            }

            goToStep('step-second-half');
        };

        // --- GESTIONE MULTI-BERSAGLIO E BURST (B) ---
        window.totalBurst = 3;
        window.combatTargets = [];

        window.adjustTotalBurst = (val) => {
            window.totalBurst = Math.max(1, window.totalBurst + val);
            let currentAllocated = window.combatTargets.reduce((sum, t) => sum + t.burst, 0);
            if (currentAllocated > window.totalBurst) {
                // Se abbassi il Burst totale sotto la soglia usata, toglie dadi al primo bersaglio valido
                for(let t of window.combatTargets) { if(t.burst > 0) { t.burst--; break; } }
            }
            document.getElementById('total-burst-display').innerText = window.totalBurst;
            renderTargetsAllocation();
        };

        window.adjustTargetBurst = (index, val) => {
            let currentAllocated = window.combatTargets.reduce((sum, t) => sum + t.burst, 0);
            let tgt = window.combatTargets[index];
            if (val > 0 && currentAllocated < window.totalBurst) { tgt.burst += 1; } 
            else if (val < 0 && tgt.burst > 0) { tgt.burst -= 1; }
            renderTargetsAllocation();
        };

        window.setTargetRange = (index, mod) => { window.combatTargets[index].rangeMod = mod; renderTargetsAllocation(); };
        window.toggleTargetCover = (index) => { window.combatTargets[index].cover = !window.combatTargets[index].cover; renderTargetsAllocation(); };

        window.addNewTarget = () => {
            window.combatTargets.push({ id: "generic", name: "Bersaglio Aggiuntivo", skills: "", rangeMod: 0, burst: 0, cover: false });
            renderTargetsAllocation();
        };

        // Genera le "schede" visive per ogni nemico
        window.renderTargetsAllocation = () => {
            const container = document.getElementById('targets-allocation-container');
            container.innerHTML = "";
            let currentAllocated = window.combatTargets.reduce((sum, t) => sum + t.burst, 0);
            let remainingB = window.totalBurst - currentAllocated;
            let isAttackBS = window.currentOrder.action.includes('ATTACCO BS');
            
            let wpnProfile = window.getWeaponProfile(window.currentOrder.weapon);

            window.combatTargets.forEach((tgt, index) => {
                let coverColor = tgt.cover ? 'var(--nomad-orange)' : '#1a0000';
                let coverText = tgt.cover ? '#000' : '#fff';
                
                let autoLog = "";
                if(tgt.skills.includes("mimetism (-6)")) autoLog += `<span style="color:#ff3333; font-size:12px; margin-left:10px;">⚠️ Mimetico (-6)</span>`;
                else if(tgt.skills.includes("mimetism (-3)") || tgt.skills.includes("camouflage")) autoLog += `<span style="color:#ff3333; font-size:12px; margin-left:10px;">⚠️ Mimetico (-3)</span>`;
                
                let segmentsHtml = "";
                let labelsHtml = "";
                wpnProfile.bands.forEach((band, bIdx) => {
                    let colorClass = "seg-2"; 
                    if(band.mod > 0) colorClass = "seg-1"; 
                    else if(band.mod === -3) colorClass = "seg-3"; 
                    else if(band.mod < -3) colorClass = "seg-4"; 
                    let isActive = (tgt.rangeIndex === bIdx) ? "active" : "";
                    
                    segmentsHtml += `<div class="range-seg ${colorClass} ${isActive}" onclick="setTargetRange(${index}, ${bIdx}, ${band.mod})">${band.mod > 0 ? '+'+band.mod : band.mod}</div>`;
                    labelsHtml += `<span>${band.label}</span>`;
                });

                let rangeHtml = isAttackBS ? `
                    <div style="margin-top:15px;">
                        <span style="color:#aaa; font-size:14px;">Distanza Gittata (${window.currentOrder.weapon}):</span>
                        <div class="range-bar">${segmentsHtml}</div>
                        <div style="display:flex; justify-content:space-between; font-size:11px; color:#aaa; margin-top:2px; padding:0 5px;">${labelsHtml}</div>
                    </div>
                ` : "";

                container.innerHTML += `
                    <div class="target-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px dashed #444; padding-bottom: 10px;">
                            <b style="color:var(--nomad-orange); font-size:22px;">${tgt.name}</b>
                            ${autoLog}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                            <span style="color:#fff; font-size:16px;">Assegna Dadi (B):</span>
                            <div class="burst-ctrl">
                                <button class="burst-btn" onclick="adjustTargetBurst(${index}, -1)">-</button>
                                <span style="color:${tgt.burst > 0 ? '#00ff00' : '#fff'}; font-size:24px; font-weight:bold; min-width:20px; text-align:center;">${tgt.burst}</span>
                                <button class="burst-btn" style="opacity:${remainingB > 0 ? 1 : 0.3}" onclick="adjustTargetBurst(${index}, 1)">+</button>
                            </div>
                        </div>
                        ${rangeHtml}
                        <button class="huge-btn" style="background:${coverColor}; color:${coverText}; min-height:50px; font-size:18px; margin-top:15px; width:100%;" onclick="toggleTargetCover(${index})">COPERTURA BERSAGLIO</button>
                    </div>
                `;
            });
        };

        // Aggiorniamo anche l'inizializzazione in goToModifiers per usare il range corretto di partenza
        window.goToModifiers = (finalAction) => {
            if(finalAction) window.currentOrder.action = finalAction;
            document.getElementById('calc-result').style.display = 'none';
            
            // CARICAMENTO PROFILO ARMA DINAMICO
            let wpnProfile = window.getWeaponProfile(window.currentOrder.weapon);
            
            // IL BURST ORA E' LETTO DAL DATABASE DELL'ARMA
            window.totalBurst = window.currentOrder.action.includes('ATTACCO BS') ? wpnProfile.burst : 1; 
            window.combatTargets = [];
            
            if (window.currentOrder.target) {
                window.combatTargets.push({ id: window.currentOrder.target.id_profilo, name: window.currentOrder.target.nome, skills: window.currentOrder.target.skills.toLowerCase(), rangeIndex: 0, rangeMod: wpnProfile.bands[0].mod, burst: window.totalBurst, cover: false });
            } else {
                window.combatTargets.push({ id: "generic1", name: "Bersaglio Primario", skills: "", rangeIndex: 0, rangeMod: wpnProfile.bands[0].mod, burst: window.totalBurst, cover: false });
            }

            document.getElementById('total-burst-display').innerText = window.totalBurst;
            
            if (window.currentOrder.action.includes('ATTACCO BS')) {
                document.getElementById('burst-header-ui').style.display = 'flex';
                document.getElementById('add-target-btn').style.display = 'block';
            } else {
                document.getElementById('burst-header-ui').style.display = 'none';
                document.getElementById('add-target-btn').style.display = 'none';
            }
            
            window.renderTargetsAllocation();
            goToStep('step-modifiers');
        };

        window.executeCalculation = () => {
            const order = window.currentOrder;
            let activeTargets = window.combatTargets.filter(t => t.burst > 0);
            let wpnProfile = window.getWeaponProfile(order.weapon);
            
            // Visualizza info Arma
            let weaponInfo = order.action.includes('ATTACCO BS') ? `<br><span style="color:var(--nomad-orange); font-size:14px;">[ARMA: ${order.weapon} | DAM: ${wpnProfile.dam} | AMMO: ${wpnProfile.ammo}]</span>` : '';

            let resHtml = `<div style="color:#fff; line-height:1.6;">
                           <b>ATTACCANTE:</b> ${order.unit.alias}<br>
                           <b>AZIONE:</b> ${order.action} ${weaponInfo}<br>
                           <hr style="border-color:var(--nomad-orange);">`;

            if(activeTargets.length === 0) {
                resHtml += `<p style="color:#ff3333; text-align:center; font-weight:bold;">Assegna almeno 1 Dado (B)!</p></div>`;
                document.getElementById('calc-result').innerHTML = resHtml; document.getElementById('calc-result').style.display = 'block'; return;
            }

            activeTargets.forEach(tgt => {
                let base = 0; let attrName = ""; let modTotal = 0; let modLog = "";
                const unitSkills = order.unit.skills.toLowerCase();

                if (order.action.includes('ATTACCO BS')) { 
                    // Se l'arma usa PH (es. Granate), cambia attributo!
                    attrName = wpnProfile.attr;
                    base = attrName === "PH" ? order.unit.ph : order.unit.bs; 
                    
                    if(tgt.cover) { modTotal -= 3; modLog += `> Copertura: <b style="color:#ff3333;">-3</b><br>`; }
                    modTotal += tgt.rangeMod;
                    modLog += `> Gittata: <b style="color:${tgt.rangeMod>0?'#00ff00':'#ff3333'};">${tgt.rangeMod>0?'+':''}${tgt.rangeMod}</b><br>`;
                    if(tgt.skills.includes("mimetism (-6)")) { modTotal -= 6; modLog += `> Mimetismo: <b style="color:#ff3333;">-6</b><br>`; }
                    else if(tgt.skills.includes("mimetism (-3)") || tgt.skills.includes("camouflage")) { modTotal -= 3; modLog += `> Mimetismo: <b style="color:#ff3333;">-3</b><br>`; }
                }
                else if (order.action.includes('CORPO A CORPO')) { 
                    base = order.unit.cc; attrName = "CC"; 
                    if(unitSkills.includes("martial arts")) { modTotal += 3; modLog += `> Arti Marziali: <b style="color:#00ff00;">+3</b><br>`; }
                }

                let targetNum = base + modTotal;
                resHtml += `
                    <div style="background:#1a0000; padding:15px; border:1px solid var(--nomad-red); margin-bottom:15px; border-radius:5px;">
                        <b style="color:var(--nomad-orange); font-size:20px;">VS ${tgt.name}</b> 
                        <span style="background:#00ff00; color:#000; padding:3px 10px; font-weight:bold; border-radius:3px; float:right;">DADI (B): ${tgt.burst}</span><br>
                        <div style="margin-top:10px;">
                            <span style="color:#aaa; font-size:14px;">Base (${attrName}): ${base}</span><br>
                            ${modLog}
                        </div>
                        <hr style="border-color:#444;">
                        <div style="font-size:32px; color:#00ff00; font-weight:bold; text-align:center;">TARGET SU D20: ${targetNum}</div>
                    </div>`;
            });

            resHtml += `</div>`;
            document.getElementById('calc-result').innerHTML = resHtml; document.getElementById('calc-result').style.display = 'block';
        };
            resHtml += `</div>`;
            const resBox = document.getElementById('calc-result');
            resBox.innerHTML = resHtml; resBox.style.display = 'block';
        };

    </script>
</body>
</html>
