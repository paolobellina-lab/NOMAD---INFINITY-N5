        // --- RENDER ROSTER CON TASTO CORREZIONE MANUALE ---
        window.renderRoster = () => {
            const container = document.getElementById('localRoster');
            if(window.roster.length === 0) return container.innerHTML = "<i>Nessuna unit√† schierata.</i>";
            container.innerHTML = "<div style='color:var(--nomad-orange); margin-bottom:5px;'>UNIT√Ä PRONTE:</div>";
            window.roster.forEach((u, i) => {
                const armaCorta = u.weapon.split('/')[0].split(',')[0];
                container.innerHTML += `
                    <div class="roster-item">
                        <div><b>${u.alias}</b> <span style="color:#aaa; font-size:10px;">| [${armaCorta}]</span></div>
                        <div style="display:flex;">
                            <div class="rec-btn" onclick="addManualDictionary('${u.alias}')">üìù CORREGGI IA</div>
                            <div class="del-btn" onclick="removeUnit(${i})">X</div>
                        </div>
                    </div>`;
            });
        };

        // --- SISTEMA DI INSERIMENTO MANUALE NEL VOCABOLARIO ---
        window.addManualDictionary = (alias) => {
            // Chiede all'utente di digitare la parola sbagliata
            let wrongWord = prompt(`L'IA capisce male il nome di ${alias} in battaglia?\n\nGuarda la console, controlla cosa capisce l'IA (es. "gatto" o "acqua cile") e scrivilo qui sotto:`);
            
            if (wrongWord && wrongWord.trim() !== "") {
                wrongWord = wrongWord.toLowerCase().trim();
                
                // Salva nel dizionario
                window.customDictionary[wrongWord] = alias.toLowerCase();
                localStorage.setItem('infinityDictionary_Nomads', JSON.stringify(window.customDictionary));
                
                alert(`VOCABOLARIO AGGIORNATO!\n\nDa ora in poi, ogni volta che l'IA capir√† "${wrongWord}", lo tradurr√† istantaneamente in "${alias}".`);
            }
        };

        // Rimuoviamo la vecchia funzione window.startLearning e le modifiche a btnListen 
        // L'evento onresult del riconoscimento vocale ora √® pulito e dedicato solo alla battaglia:
        
        const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.lang = 'it-IT';
        
        document.getElementById('btnListen').onclick = () => {
            recognition.start();
        };
        
        recognition.onstart = () => {
            document.getElementById('btnListen').classList.add('recording');
        };
        
        recognition.onresult = async (event) => {
            document.getElementById('btnListen').classList.remove('recording');
            let testo = event.results[0][0].transcript.toLowerCase().trim();
            
            // --- SOSTITUZIONE INTELLIGENTE (Dal pi√π lungo al pi√π corto) ---
            const chiaviOrdinate = Object.keys(window.customDictionary).sort((a, b) => b.length - a.length);
            chiaviOrdinate.forEach(wrongPhrase => {
                const correctAlias = window.customDictionary[wrongPhrase];
                // Sostituisce la parola sbagliata con l'alias corretto
                testo = testo.replace(new RegExp(`\\b${wrongPhrase}\\b`, 'g'), correctAlias);
            });

            elaboraComando(testo);
        };
